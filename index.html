<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Savvy OS - My Jobs</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .glass-effect { 
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .job-card {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .job-card:active {
            transform: scale(0.98);
        }
        .status-ready {
            background: linear-gradient(135deg, #dcfce7, #86efac);
            border: 2px solid #22c55e;
            animation: readyPulse 2s ease-in-out infinite;
        }
        .status-waiting {
            background: linear-gradient(135deg, #fef3c7, #fde047);
            border: 2px solid #eab308;
        }
        .status-progress {
            background: linear-gradient(135deg, #dbeafe, #93c5fd);
            border: 2px solid #3b82f6;
        }
        @keyframes readyPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        .location-active {
            animation: locationPulse 2s ease-in-out infinite;
        }
        @keyframes locationPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4);
        }
        .notification-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            z-index: 1000;
            max-width: 90%;
        }
        .notification-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            transition: all 0.3s ease-in-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        .badge-pulse {
            animation: badgePulse 2s ease-in-out infinite;
        }
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .hidden { display: none !important; }
        .modal-card { background: white; border-radius: 1rem; padding: 1rem; }
        .check-button { min-height: 48px; border-radius: 10px; padding: 0.6rem 1rem; }
        .photo-preview { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; }
        .small-note { font-size: 0.85rem; color: #475569; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">

<header class="glass-effect sticky top-0 z-50 border-b border-white/20">
    <div class="px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="savvy-os-logo.png" alt="Savvy OS" class="w-10 h-10 rounded-xl">
                <div>
                    <h1 class="text-xl font-bold text-slate-800">My Jobs</h1>
                    <p class="text-xs text-slate-600" id="cleanerName">Sarah Johnson</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="locationBtn" onclick="toggleLocation()" class="relative p-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors">
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <div id="locationDot" class="absolute top-1 right-1 w-2.5 h-2.5 bg-gray-400 rounded-full"></div>
                </button>
                
                <div class="relative">
                    <button class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors">
                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </button>
                    <div id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center badge-pulse hidden">0</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="relative px-4">
        <div class="flex space-x-1 border-b border-slate-200">
            <button onclick="switchTab('today')" class="tab-btn flex-1 px-4 py-3 text-sm font-semibold text-blue-600 relative" data-tab="today">
                Today
                <span class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs" id="todayCount">0</span>
            </button>
            <button onclick="switchTab('week')" class="tab-btn flex-1 px-4 py-3 text-sm font-semibold text-slate-600 relative" data-tab="week">
                Week
                <span class="ml-1 px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full text-xs" id="weekCount">0</span>
            </button>
            <button onclick="switchTab('upcoming')" class="tab-btn flex-1 px-4 py-3 text-sm font-semibold text-slate-600 relative" data-tab="upcoming">
                Upcoming
                <span class="ml-1 px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full text-xs" id="upcomingCount">0</span>
            </button>
            <button onclick="switchTab('completed')" class="tab-btn flex-1 px-4 py-3 text-sm font-semibold text-slate-600 relative" data-tab="completed">
                Completed
                <span class="ml-1 px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full text-xs" id="completedCount">0</span>
            </button>
        </div>
        <div class="tab-indicator" style="left: 0; width: 25%;"></div>
    </div>
</header>

<main class="px-4 py-4 pb-24">
    <div class="grid grid-cols-3 gap-3 mb-4">
        <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100">
            <div class="text-2xl font-bold text-blue-600" id="statsTotal">0</div>
            <div class="text-xs text-slate-600 font-medium">Total Today</div>
        </div>
        <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100">
            <div class="text-2xl font-bold text-green-600" id="statsReady">0</div>
            <div class="text-xs text-slate-600 font-medium">Ready Now</div>
        </div>
        <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100">
            <div class="text-2xl font-bold text-amber-600" id="statsWaiting">0</div>
            <div class="text-xs text-slate-600 font-medium">Waiting</div>
        </div>
    </div>

    <div id="weekStrip" class="mb-4 hidden">
        <div class="flex gap-2 overflow-x-auto"></div>
    </div>

    <div id="jobsList" class="space-y-4"></div>

    <div id="emptyState" class="text-center py-12 hidden">
        <div class="w-20 h-20 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
            <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">No Jobs Here</h3>
        <p class="text-sm text-slate-500">Check other tabs for assignments</p>
    </div>
</main>

<button onclick="refreshJobs()" class="floating-btn w-14 h-14 bg-gradient-to-r from-blue-600 to-blue-700 rounded-full flex items-center justify-center text-white hover:from-blue-700 hover:to-blue-800 transition-all">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
    </svg>
</button>

<div id="notificationToast" class="notification-toast">
    <div class="glass-effect rounded-xl p-4 shadow-xl border-l-4 border-blue-500">
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <p id="toastMessage" class="text-sm font-medium text-slate-800"></p>
            </div>
        </div>
    </div>
</div>

<div id="jobModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden" onclick="closeModal(event)">
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[85vh] overflow-y-auto slide-up" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white border-b border-slate-200 px-4 py-4 flex items-center justify-between rounded-t-3xl">
            <h2 class="text-xl font-bold text-slate-800" id="modalTitle">Job Details</h2>
            <button onclick="closeJobModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="modalContent" class="p-4"></div>
    </div>
</div>

<div id="overrideModal" class="fixed inset-0 bg-black/60 z-60 hidden" onclick="closeOverrideModal(event)">
    <div class="absolute inset-0" onclick="event.stopPropagation()"></div>
    <div class="absolute left-4 right-4 bottom-6 bg-white rounded-2xl p-4 slide-up">
        <div class="flex items-start justify-between mb-3">
            <div>
                <h3 class="text-lg font-bold">Start cleaning — override</h3>
                <p class="small-note mt-1">Guests are listed as still in the unit. Only override if you have verified guests have left or property approved it.</p>
            </div>
            <button onclick="closeOverrideModal()" class="p-2 rounded-lg hover:bg-slate-100">✕</button>
        </div>
        <label class="block text-sm text-slate-700 mb-2">Optional note (why you override)</label>
        <textarea id="overrideNote" class="w-full p-3 rounded-lg border border-slate-200" rows="3" placeholder="e.g., manager confirmed; I checked outside..."></textarea>
        <div class="mt-4 grid grid-cols-2 gap-3">
            <button id="confirmOverrideBtn" class="px-4 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-semibold">Confirm & Start</button>
            <button class="px-4 py-3 bg-white rounded-xl font-semibold border border-slate-200" onclick="closeOverrideModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="checklistModal" class="fixed inset-0 bg-black/60 z-70 hidden" onclick="closeChecklistModal(event)">
    <div class="absolute inset-0" onclick="event.stopPropagation()"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl max-h-[86vh] overflow-y-auto p-4 slide-up">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">Post-cleaning checklist</h3>
            <button onclick="closeChecklistModal()" class="p-2 rounded-lg hover:bg-slate-100">Close</button>
        </div>
        <div id="checklistItems" class="space-y-3"></div>
        <div class="mt-3">
            <label class="block text-sm font-semibold mb-1">Attach photo (optional)</label>
            <input id="checklistPhoto" type="file" accept="image/*" capture="environment" class="hidden" />
            <label for="checklistPhoto" class="w-full p-3 bg-slate-50 rounded-xl cursor-pointer flex items-center gap-3">
                <svg class="w-6 h-6 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="3" y="7" width="18" height="13" rx="2" stroke-width="1.5"></rect>
                    <path d="M8 11a2 2 0 112 2 2 2 0 01-2-2z" stroke-width="1.5"></path>
                </svg>
                <span id="photoLabel" class="text-slate-600">Tap to take or choose photo</span>
            </label>
            <div id="photoPreviewWrap" class="mt-3 hidden">
                <img id="photoPreview" class="photo-preview" alt="photo preview" />
                <button id="removePhotoBtn" class="mt-2 w-full px-3 py-2 bg-white rounded-xl border">Remove Photo</button>
            </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3">
            <button id="submitChecklistBtn" class="px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-semibold">Submit & Complete</button>
            <button class="px-4 py-3 bg-white rounded-xl border font-semibold" onclick="closeChecklistModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
const LS_JOBS_KEY = 'savvy.jobs.v3';
const LS_CHECKLISTS_KEY = 'savvy.checklists.v2';
const LS_OVERRIDES_KEY = 'savvy.overrides.v2';
const LS_PHOTOS_KEY = 'savvy.photos.v2';
const LS_LOCATION_KEY = 'savvy.location.v2';

function getTodayISO() {
    return new Date().toISOString().split('T')[0];
}

function getInitialJobs() {
    const today = getTodayISO();
    return [
        {
            id: 1,
            location: 'Downtown Hotel',
            address: '123 Main St, Ocean City, MD 21842',
            room: '205',
            roomType: 'Deluxe Suite',
            startTime: '09:00',
            dueTime: '11:00',
            predictedTime: '2h 0m',
            guestCount: 2,
            dogCount: 0,
            wifiIncluded: true,
            linenPickup: true,
            guestsOut: true,
            priority: 'high',
            lockCode: '356374',
            wifiNetwork: 'Rockyroad',
            wifiPassword: 'COvid$Sucks!',
            bedInfo: '1 King Bed',
            bathInfo: '1 Full Bath',
            permanentInstructions: 'Standard deep clean protocol',
            weekSpecificInstructions: 'Focus on bathroom deep clean',
            linenInstructions: 'Pick up at 128th Street office',
            parkingSpace: 'Space #A-12',
            parkingInstructions: 'Enter through main gate',
            date: today,
            status: 'assigned'
        },
        {
            id: 2,
            location: 'Riverside Inn',
            address: '456 River Rd, Ocean City, MD 21843',
            room: '312',
            roomType: 'Standard Room',
            startTime: '12:00',
            dueTime: '14:00',
            predictedTime: '2h 0m',
            guestCount: 3,
            dogCount: 1,
            wifiIncluded: true,
            linenPickup: false,
            guestsOut: false,
            priority: 'normal',
            lockCode: '789456',
            wifiNetwork: 'RiversideGuest',
            wifiPassword: 'Welcome2023!',
            bedInfo: '2 Queen Beds',
            bathInfo: '1 Full Bath',
            permanentInstructions: 'Standard clean',
            weekSpecificInstructions: 'Extra attention to carpets',
            linenInstructions: 'N/A',
            parkingSpace: 'Space #B-5',
            parkingInstructions: 'Park in visitor lot',
            date: today,
            status: 'assigned'
        },
        {
            id: 3,
            location: 'City Center Lodge',
            address: '789 City Ave, Ocean City, MD 21844',
            room: '108',
            roomType: 'Presidential Suite',
            startTime: '14:30',
            dueTime: '17:00',
            predictedTime: '2h 30m',
            guestCount: 4,
            dogCount: 0,
            wifiIncluded: true,
            linenPickup: true,
            guestsOut: true,
            priority: 'high',
            lockCode: '112233',
            wifiNetwork: 'CityCenterVIP',
            wifiPassword: 'Luxury@2023',
            bedInfo: '1 King Bed, 2 Twin Beds',
            bathInfo: '2 Full Baths',
            permanentInstructions: 'VIP treatment - white glove service',
            weekSpecificInstructions: 'Polish all surfaces',
            linenInstructions: 'Pick up premium linens at front desk',
            parkingSpace: 'Space #V-1',
            parkingInstructions: 'VIP parking entrance',
            date: today,
            status: 'assigned'
        }
    ];
}

function loadJobsFromLS() {
    try {
        const raw = localStorage.getItem(LS_JOBS_KEY);
        if (!raw) {
            const initialJobs = getInitialJobs();
            localStorage.setItem(LS_JOBS_KEY, JSON.stringify(initialJobs));
            return initialJobs;
        }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) {
            const initialJobs = getInitialJobs();
            localStorage.setItem(LS_JOBS_KEY, JSON.stringify(initialJobs));
            return initialJobs;
        }
        return parsed;
    } catch (e) {
        console.error('Error loading jobs', e);
        const initialJobs = getInitialJobs();
        localStorage.setItem(LS_JOBS_KEY, JSON.stringify(initialJobs));
        return initialJobs;
    }
}

function saveJobsToLS(jobs) {
    localStorage.setItem(LS_JOBS_KEY, JSON.stringify(jobs));
}

function loadChecklistsFromLS() {
    return JSON.parse(localStorage.getItem(LS_CHECKLISTS_KEY) || '{}');
}

function saveChecklistsToLS(obj) {
    localStorage.setItem(LS_CHECKLISTS_KEY, JSON.stringify(obj));
}

function loadOverridesFromLS() {
    return JSON.parse(localStorage.getItem(LS_OVERRIDES_KEY) || '{}');
}

function saveOverridesToLS(obj) {
    localStorage.setItem(LS_OVERRIDES_KEY, JSON.stringify(obj));
}

function loadPhotosFromLS() {
    return JSON.parse(localStorage.getItem(LS_PHOTOS_KEY) || '{}');
}

function savePhotosToLS(obj) {
    localStorage.setItem(LS_PHOTOS_KEY, JSON.stringify(obj));
}

let jobs = loadJobsFromLS();
let currentTab = 'today';
let activeJobId = null;
let checklistPhotoData = null;
let locationWatchId = null;
let locationEnabled = false;

function q(sel) { return document.querySelector(sel); }
function todayISO() { return new Date().toISOString().split('T')[0]; }
function addDaysISO(iso, days) {
    const d = new Date(iso + 'T00:00:00');
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
}
function startOfWeekISO(iso) {
    const d = new Date(iso + 'T00:00:00');
    const day = d.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    d.setDate(d.getDate() + diff);
    return d.toISOString().split('T')[0];
}
function isDateInWeekISO(dateISO, anchorISO) {
    const start = new Date(startOfWeekISO(anchorISO) + 'T00:00:00');
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    const dt = new Date(dateISO + 'T00:00:00');
    return dt >= start && dt <= end;
}
function showToast(message, type='info') {
    const toast = q('#notificationToast');
    const toastMessage = q('#toastMessage');
    const colors = {
        success: 'border-green-500',
        error: 'border-red-500',
        warning: 'border-yellow-500',
        info: 'border-blue-500'
    };
    toast.querySelector('.glass-effect').className = `glass-effect rounded-xl p-4 shadow-xl border-l-4 ${colors[type] || colors.info}`;
    toastMessage.textContent = message;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 3000);
}

function toggleLocation() {
    if (locationEnabled) {
        stopLocationSharing();
    } else {
        startLocationSharing();
    }
}

function startLocationSharing() {
    if (!navigator.geolocation) {
        showToast('Location not supported by your device', 'error');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            locationEnabled = true;
            const dot = q('#locationDot');
            dot.classList.remove('bg-gray-400');
            dot.classList.add('bg-green-500', 'location-active');
            
            locationWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const locationData = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        timestamp: Date.now(),
                        cleanerName: q('#cleanerName').textContent,
                        cleanerId: 'cleaner_001'
                    };
                    localStorage.setItem(LS_LOCATION_KEY, JSON.stringify(locationData));
                    console.log('Location updated:', locationData);
                },
                (error) => {
                    console.error('Location error:', error);
                    stopLocationSharing();
                    showToast('Location tracking error', 'error');
                },
                { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
            );
            
            showToast('Location sharing enabled', 'success');
        },
        (error) => {
            showToast('Unable to access location', 'error');
            console.error('Location error:', error);
        }
    );
}

function stopLocationSharing() {
    if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
    }
    locationEnabled = false;
    const dot = q('#locationDot');
    dot.classList.remove('bg-green-500', 'location-active');
    dot.classList.add('bg-gray-400');
    localStorage.removeItem(LS_LOCATION_KEY);
    showToast('Location sharing disabled', 'info');
}

function updateCounts() {
    const today = todayISO();
    q('#todayCount').textContent = jobs.filter(j => j.date === today && (j.status === 'assigned' || j.status === 'in_progress')).length;
    const weekAnchor = today;
    q('#weekCount').textContent = jobs.filter(j => isDateInWeekISO(j.date, weekAnchor) && (j.status === 'assigned' || j.status === 'in_progress')).length;
    q('#upcomingCount').textContent = jobs.filter(j => j.date > today && (j.status === 'assigned' || j.status === 'in_progress')).length;
    q('#completedCount').textContent = jobs.filter(j => j.status === 'completed').length;
    q('#statsTotal').textContent = jobs.filter(j => j.date === today && (j.status === 'assigned' || j.status === 'in_progress')).length;
    q('#statsReady').textContent = jobs.filter(j => j.date === today && (j.status === 'assigned' || j.status === 'in_progress') && j.guestsOut).length;
    q('#statsWaiting').textContent = jobs.filter(j => j.date === today && (j.status === 'assigned' || j.status === 'in_progress') && !j.guestsOut).length;
}

function renderWeekStrip() {
    const stripWrap = q('#weekStrip');
    const stripInner = stripWrap.querySelector('div');
    const anchor = todayISO();
    const start = startOfWeekISO(anchor);
    stripInner.innerHTML = '';
    for (let i=0;i<7;i++) {
        const dISO = addDaysISO(start, i);
        const d = new Date(dISO + 'T00:00:00');
        const label = d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });
        const count = jobs.filter(j => j.date === dISO && (j.status === 'assigned' || j.status === 'in_progress')).length;
        const btn = document.createElement('button');
        btn.className = 'px-3 py-2 rounded-lg bg-white';
        btn.style.minWidth = '84px';
        btn.innerHTML = `<div class="text-sm font-semibold">${label}</div><div class="text-xs text-slate-600">${count} jobs</div>`;
        btn.onclick = () => {
            window._savvy_filterDate = dISO;
            switchTab('today');
        };
        stripInner.appendChild(btn);
    }
    stripWrap.classList.remove('hidden');
}

function renderJobs() {
    updateCounts();
    const mapping = ['today','week','upcoming','completed'];
    const idx = mapping.indexOf(currentTab);
    const indicator = document.querySelector('.tab-indicator');
    if (indicator) {
        indicator.style.left = `${idx * 25}%`;
        indicator.style.width = `25%`;
    }

    if (currentTab === 'week') renderWeekStrip();
    else q('#weekStrip').classList.add('hidden');

    const container = q('#jobsList');
    const emptyState = q('#emptyState');
    const today = todayISO();

    let filteredJobs = jobs.filter(job => {
        if (currentTab === 'today') {
            const filterDate = window._savvy_filterDate || today;
            return job.date === filterDate && (job.status === 'assigned' || job.status === 'in_progress');
        } else if (currentTab === 'week') {
            return isDateInWeekISO(job.date, today) && (job.status === 'assigned' || job.status === 'in_progress');
        } else if (currentTab === 'upcoming') {
            return job.date > today && (job.status === 'assigned' || job.status === 'in_progress');
        } else if (currentTab === 'completed') {
            return job.status === 'completed';
        } else {
            return false;
        }
    });

    if (filteredJobs.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');
    container.innerHTML = filteredJobs.map(job => createJobCardHTML(job)).join('');
}

function createJobCardHTML(job) {
    let statusClass, statusText, statusIcon;
    
    if (job.status === 'in_progress') {
        statusClass = 'status-progress';
        statusText = '🔄 CLEANING IN PROGRESS';
        statusIcon = '🔄';
    } else if (job.guestsOut) {
        statusClass = 'status-ready';
        statusText = '✓ READY TO CLEAN';
        statusIcon = '✓';
    } else {
        statusClass = 'status-waiting';
        statusText = '⏳ GUESTS STILL IN';
        statusIcon = '⏳';
    }
    
    const priorityBadge = job.priority === 'high' ? `
        <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full border border-red-200">
            URGENT
        </span>
    ` : '';

    return `
        <div class="job-card bg-white rounded-2xl shadow-lg border-2 border-slate-100 overflow-hidden" onclick="openJobModal(${job.id})">
            <div class="${statusClass} px-4 py-3 text-center font-bold text-sm">
                ${statusText}
            </div>
            
            <div class="p-4">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-xl font-bold text-slate-800">Room ${job.room}</h3>
                            ${priorityBadge}
                        </div>
                        <p class="text-sm text-slate-600 font-medium">${job.roomType}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl">${statusIcon}</div>
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-3 text-slate-700">
                    <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <span class="text-sm font-medium">${job.location}</span>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="flex items-center gap-2 text-slate-600">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm">${job.startTime}-${job.dueTime}</span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-600">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <span class="text-sm">${job.guestCount} guests</span>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 mb-3">
                    ${job.wifiIncluded ? '<span class="px-2 py-1 bg-blue-50 text-blue-700 text-xs font-semibold rounded-full border border-blue-200">WiFi</span>' : ''}
                    ${job.linenPickup ? '<span class="px-2 py-1 bg-amber-50 text-amber-700 text-xs font-semibold rounded-full border border-amber-200">Linen Pickup</span>' : ''}
                    ${job.dogCount > 0 ? `<span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs font-semibold rounded-full border border-purple-200">${job.dogCount} Dog${job.dogCount > 1 ? 's' : ''}</span>` : ''}
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <button onclick="event.stopPropagation(); navigate(${job.id})" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                        </svg>
                        Navigate
                    </button>
                    <button onclick="event.stopPropagation(); callProperty(${job.id})" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        Call
                    </button>
                    <button onclick="event.stopPropagation(); openJobModal(${job.id})" class="px-3 py-2 bg-slate-600 text-white rounded-lg text-sm font-semibold hover:bg-slate-700 transition-colors flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        Details
                    </button>
                </div>
            </div>
        </div>
    `;
}

function openJobModal(jobId) {
    activeJobId = jobId;
    const job = jobs.find(j => j.id === jobId);
    if (!job) return;
    const modal = q('#jobModal');
    const title = q('#modalTitle');
    const content = q('#modalContent');
    title.textContent = `${job.location} - Room ${job.room}`;

    let statusBanner = '';
    let startButton = '';
    
    if (job.status === 'in_progress') {
        statusBanner = `<div class="status-progress px-6 py-4 rounded-xl text-center font-bold text-lg mb-4">🔄 CLEANING IN PROGRESS</div>`;
        startButton = `<button onclick="openChecklistModal(${job.id})" class="w-full px-4 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-bold text-lg hover:from-green-700 hover:to-green-800 transition-all shadow-lg flex items-center justify-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            COMPLETE CLEANING
        </button>`;
    } else if (job.guestsOut) {
        statusBanner = `<div class="status-ready px-6 py-4 rounded-xl text-center font-bold text-lg mb-4">✓ GUESTS OUT - READY TO CLEAN</div>`;
        startButton = `<button onclick="attemptStart(${job.id})" class="w-full px-4 py-4 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg flex items-center justify-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            START CLEANING
        </button>`;
    } else {
        statusBanner = `<div class="status-waiting px-6 py-4 rounded-xl text-center font-bold text-lg mb-4">⏳ GUESTS STILL IN UNIT</div>`;
        startButton = `<button onclick="attemptStart(${job.id})" class="w-full px-4 py-4 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg flex items-center justify-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            START CLEANING
        </button>`;
    }

    content.innerHTML = `
        ${statusBanner}

        <div class="bg-gradient-to-br from-red-50 to-orange-50 border-2 border-red-200 rounded-xl p-4 mb-4">
            <h3 class="font-bold text-red-900 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                Access Information
            </h3>
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-red-800 font-medium">Lock Code:</span>
                    <span class="text-2xl font-bold text-red-900 tracking-wider">${job.lockCode}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-red-800 font-medium">WiFi Password:</span>
                    <span class="text-lg font-bold text-red-900">${job.wifiPassword || '—'}</span>
                </div>
            </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl p-4 mb-4">
            <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Schedule & Time
            </h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-slate-600">Start Time:</span>
                    <span class="font-semibold text-slate-800">${job.startTime}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-600">Due Time:</span>
                    <span class="font-semibold text-slate-800">${job.dueTime}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-600">Estimated Duration:</span>
                    <span class="font-semibold text-slate-800">${job.predictedTime}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-600">Guests:</span>
                    <span class="font-semibold text-slate-800">${job.guestCount} people${job.dogCount > 0 ? `, ${job.dogCount} dog${job.dogCount > 1 ? 's' : ''}` : ''}</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="navigate(${job.id})" class="px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold">Navigate</button>
            <button onclick="callProperty(${job.id})" class="px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-semibold">Call Property</button>
        </div>

        ${startButton}
    `;

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeJobModal() {
    q('#jobModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function closeModal(e) { 
    if (e.target.id === 'jobModal') closeJobModal(); 
}

function attemptStart(jobId) {
    const job = jobs.find(j => j.id === jobId);
    if (!job) return;
    
    if (job.status === 'in_progress') {
        closeJobModal();
        openChecklistModal(jobId);
        return;
    }
    
    if (job.guestsOut) {
        job.status = 'in_progress';
        saveJobsToLS(jobs);
        showToast('Job started', 'success');
        closeJobModal();
        renderJobs();
    } else {
        openOverrideModal(jobId);
    }
}

function openOverrideModal(jobId) {
    activeJobId = jobId;
    q('#overrideNote').value = '';
    q('#overrideModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    q('#confirmOverrideBtn').onclick = () => {
        const note = q('#overrideNote').value.trim();
        confirmOverrideAndStart(jobId, note);
    };
}

function closeOverrideModal(e) {
    if (e && e.target && e.target.id !== 'overrideModal') return;
    q('#overrideModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function confirmOverrideAndStart(jobId, note) {
    const overrides = loadOverridesFromLS();
    overrides[jobId] = overrides[jobId] || [];
    overrides[jobId].push({ 
        at: Date.now(), 
        note, 
        by: q('#cleanerName').textContent || 'Unknown' 
    });
    saveOverridesToLS(overrides);
    
    const job = jobs.find(j => j.id === jobId);
    if (!job) return;
    
    job.guestsOut = true;
    job.status = 'in_progress';
    saveJobsToLS(jobs);
    
    closeOverrideModal();
    closeJobModal();
    showToast('Override recorded — job started', 'success');
    renderJobs();
}

const DEFAULT_CHECKLIST = [
    { key: 'trash', label: 'Trash emptied' },
    { key: 'dust', label: 'Surfaces dusted & wiped' },
    { key: 'bath', label: 'Bathroom sanitized' },
    { key: 'linens', label: 'Towels/linens replaced' },
    { key: 'floors', label: 'Floors vacuumed/mopped' }
];

function openChecklistModal(jobId) {
    activeJobId = jobId;
    checklistPhotoData = null;
    
    const container = q('#checklistItems');
    container.innerHTML = '';
    
    DEFAULT_CHECKLIST.forEach(item => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-3 bg-white rounded-xl border border-slate-200';
        row.innerHTML = `
            <div>
                <div class="font-semibold text-slate-800">${item.label}</div>
                <div class="text-xs text-slate-500">Tap button to mark complete</div>
            </div>
            <button class="check-button bg-slate-100 border-2 border-slate-300 text-slate-700 font-bold transition-all" data-key="${item.key}">
                <svg class="w-5 h-5 mx-auto hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>NO</span>
            </button>
        `;
        
        const btn = row.querySelector('button');
        btn.dataset.checked = 'false';
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isChecked = btn.dataset.checked === 'true';
            btn.dataset.checked = isChecked ? 'false' : 'true';
            
            if (!isChecked) {
                btn.classList.remove('bg-slate-100', 'border-slate-300', 'text-slate-700');
                btn.classList.add('bg-emerald-600', 'border-emerald-600', 'text-white');
                btn.querySelector('svg').classList.remove('hidden');
                btn.querySelector('span').textContent = 'YES';
            } else {
                btn.classList.remove('bg-emerald-600', 'border-emerald-600', 'text-white');
                btn.classList.add('bg-slate-100', 'border-slate-300', 'text-slate-700');
                btn.querySelector('svg').classList.add('hidden');
                btn.querySelector('span').textContent = 'NO';
            }
        });
        
        container.appendChild(row);
    });

    q('#checklistPhoto').value = '';
    q('#photoPreviewWrap').classList.add('hidden');
    q('#photoPreview').src = '';
    q('#photoLabel').textContent = 'Tap to take or choose photo';
    
    q('#checklistPhoto').onchange = handleChecklistPhoto;
    q('#removePhotoBtn').onclick = () => {
        checklistPhotoData = null;
        q('#photoPreviewWrap').classList.add('hidden');
        q('#photoPreview').src = '';
        q('#photoLabel').textContent = 'Tap to take or choose photo';
        q('#checklistPhoto').value = '';
    };
    
    q('#submitChecklistBtn').onclick = submitChecklist;
    q('#checklistModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeChecklistModal(e) {
    if (e && e.target && e.target.id !== 'checklistModal') return;
    q('#checklistModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function handleChecklistPhoto(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(ev) {
        checklistPhotoData = ev.target.result;
        q('#photoPreview').src = checklistPhotoData;
        q('#photoPreviewWrap').classList.remove('hidden');
        q('#photoLabel').textContent = 'Photo attached ✓';
    };
    reader.readAsDataURL(file);
}

function submitChecklist() {
    const btns = Array.from(document.querySelectorAll('#checklistItems button'));
    const results = {};
    btns.forEach(b => results[b.dataset.key] = b.dataset.checked === 'true');

    const checkedCount = Object.values(results).filter(Boolean).length;
    
    if (checkedCount < 3) {
        alert('Please complete at least 3 checklist items before submitting.');
        return;
    }

    const checklists = loadChecklistsFromLS();
    const id = 'cl_' + activeJobId + '_' + Date.now();
    checklists[id] = {
        jobId: activeJobId,
        results,
        photoId: null,
        ts: Date.now(),
        by: q('#cleanerName').textContent || 'Unknown'
    };

    if (checklistPhotoData) {
        const photos = loadPhotosFromLS();
        const pid = 'ph_' + activeJobId + '_' + Date.now();
        photos[pid] = {
            data: checklistPhotoData,
            ts: Date.now(),
            by: q('#cleanerName').textContent || 'Unknown'
        };
        savePhotosToLS(photos);
        checklists[id].photoId = pid;
    }

    saveChecklistsToLS(checklists);

    const idx = jobs.findIndex(j => j.id === activeJobId);
    if (idx > -1) {
        jobs[idx].status = 'completed';
        jobs[idx].completedAt = Date.now();
        jobs[idx].completedBy = q('#cleanerName').textContent || 'Unknown';
        jobs[idx].checklistId = id;
        saveJobsToLS(jobs);
    }

    closeChecklistModal();
    showToast('Job completed successfully ✅', 'success');
    renderJobs();
}

function navigate(jobId) {
    const job = jobs.find(j => j.id === jobId);
    if (!job) return;
    const address = encodeURIComponent(job.address || (job.location || ''));
    const mapsUrl = /iPhone|iPad|iPod/.test(navigator.userAgent)
        ? `maps://maps.google.com/maps?daddr=${address}`
        : `https://www.google.com/maps/dir/?api=1&destination=${address}`;
    window.open(mapsUrl, '_blank');
    showToast('Opening navigation...', 'info');
}

function callProperty(jobId) {
    showToast('Calling property manager...', 'info');
    setTimeout(() => {
        window.location.href = 'tel:+14431234567';
    }, 500);
}

function switchTab(tab) {
    currentTab = tab;
    delete window._savvy_filterDate;

    document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab === tab) {
            btn.classList.remove('text-slate-600');
            btn.classList.add('text-blue-600');
            const badge = btn.querySelector('span');
            if (badge) {
                badge.classList.remove('bg-slate-100', 'text-slate-600');
                badge.classList.add('bg-blue-100', 'text-blue-600');
            }
        } else {
            btn.classList.remove('text-blue-600');
            btn.classList.add('text-slate-600');
            const badge = btn.querySelector('span');
            if (badge) {
                badge.classList.remove('bg-blue-100', 'text-blue-600');
                badge.classList.add('bg-slate-100', 'text-slate-600');
            }
        }
    });
    
    renderJobs();
}

function refreshJobs() {
    jobs = loadJobsFromLS();
    renderJobs();
    showToast('Jobs refreshed!', 'success');
}

function updateNotificationBadge(count) {
    const badge = q('#notificationBadge');
    const currentCount = parseInt(badge.textContent || '0');
    const newCount = currentCount + count;
    if (newCount > 0) {
        badge.textContent = newCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    switchTab('today');
    renderJobs();
    showToast('Welcome back! You have new assignments.', 'info');

    setInterval(() => {
        if (Math.random() > 0.85) {
            const assignedJobs = jobs.filter(j => j.status === 'assigned');
            if (assignedJobs.length === 0) return;
            
            const randomJob = assignedJobs[Math.floor(Math.random() * assignedJobs.length)];
            const oldStatus = randomJob.guestsOut;
            
            if (!oldStatus && Math.random() > 0.5) {
                randomJob.guestsOut = true;
                saveJobsToLS(jobs);
                renderJobs();
                showToast(`🎉 Room ${randomJob.room} is now ready to clean!`, 'success');
                updateNotificationBadge(1);
            }
        }
    }, 20000);
});

window.Savvy = {
    jobsRef: () => jobs,
    saveJobs: () => saveJobsToLS(jobs),
    resetDemo: () => {
        localStorage.removeItem(LS_JOBS_KEY);
        localStorage.removeItem(LS_CHECKLISTS_KEY);
        localStorage.removeItem(LS_OVERRIDES_KEY);
        localStorage.removeItem(LS_PHOTOS_KEY);
        localStorage.removeItem(LS_LOCATION_KEY);
        jobs = loadJobsFromLS();
        renderJobs();
        showToast('Demo reset complete', 'success');
    },
    getLocation: () => {
        const loc = localStorage.getItem(LS_LOCATION_KEY);
        return loc ? JSON.parse(loc) : null;
    }
};
</script>
</body>
</html>