<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Savvy OS - My Jobs (Dark Mode)</title>
  <link rel="icon" href="favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minimal additional styles for mobile ergonomics */
    :root {
      --card: #0b1220;
      --muted: #94a3b8;
      --accent: #06b6d4;
      --accent-2: #7c3aed;
      --glass: rgba(255,255,255,0.03);
    }
    body { background: linear-gradient(180deg,#030612 0%, #071428 100%); color: #e6eef8; font-family: Inter, ui-sans-serif, system-ui; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); box-shadow: 0 6px 20px rgba(2,6,23,0.6); }
    .tab-indicator { height:3px; background: linear-gradient(90deg,var(--accent),var(--accent-2)); border-radius:2px; transition:all .25s ease; }
    .big-btn { padding: .85rem 1rem; border-radius: 12px; font-weight:700; }
    input[type="file"] { display:none; }
    .week-day { min-width:48px; }
    .check-tile { min-height:56px; }
    .photo-thumb { width:100%; height:160px; object-fit:cover; border-radius:10px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:60; }
    @media(min-width:768px){ .mobile-only { display:none; } }
  </style>
</head>
<body class="min-h-screen pb-28">

<!-- Header -->
<header class="sticky top-0 z-50 px-4 py-3 border-b border-white/6 backdrop-blur-sm">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-800 to-slate-700 flex items-center justify-center">
        <svg class="w-6 h-6 text-cyan-200" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          <path d="M8 7V4a2 2 0 012-2h4a2 2 0 012 2v3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>
      <div>
        <h1 class="text-lg font-bold">My Jobs</h1>
        <div class="text-xs text-[--muted]" id="cleanerName">Sarah Johnson • Cleaner</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button id="refreshBtn" class="p-2 rounded-lg bg-white/3 hover:bg-white/5" title="Refresh">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M4 4v6h6" stroke-width="1.6"></path>
          <path d="M20 20v-6h-6" stroke-width="1.6"></path>
          <path d="M20 4a9 9 0 10.001 0z" stroke-width="1.6"></path>
        </svg>
      </button>
      <button id="locBtn" class="p-2 rounded-lg bg-white/3 hover:bg-white/5" title="Toggle Location">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 2v4" stroke-width="1.6"></path>
          <path d="M12 18v4" stroke-width="1.6"></path>
          <path d="M4 12h4" stroke-width="1.6"></path>
          <path d="M16 12h4" stroke-width="1.6"></path>
          <circle cx="12" cy="12" r="6" stroke-width="1.6"></circle>
        </svg>
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mt-3">
    <div class="flex gap-2 relative">
      <button class="tab-btn flex-1 py-2 text-sm font-semibold text-cyan-200" data-tab="today">Today <span id="todayCount" class="ml-2 text-xs text-[--muted]"></span></button>
      <button class="tab-btn flex-1 py-2 text-sm text-[--muted]" data-tab="week">This Week <span id="weekCount" class="ml-2 text-xs text-[--muted]"></span></button>
      <button class="tab-btn flex-1 py-2 text-sm text-[--muted]" data-tab="upcoming">Upcoming <span id="upcomingCount" class="ml-2 text-xs text-[--muted]"></span></button>
      <button class="tab-btn flex-1 py-2 text-sm text-[--muted]" data-tab="completed">Completed <span id="completedCount" class="ml-2 text-xs text-[--muted]"></span></button>
    </div>
    <div class="mt-1">
      <div id="tabIndicator" class="tab-indicator" style="width:25%;"></div>
    </div>
  </div>
</header>

<!-- Controls: week nav + filters -->
<section class="px-4 mt-3 mobile-only">
  <div id="weekControls" class="hidden card p-3 rounded-xl mb-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <button id="prevWeek" class="p-2 rounded-lg bg-white/3">◀</button>
      <div id="weekLabel" class="text-sm font-semibold"></div>
      <button id="nextWeek" class="p-2 rounded-lg bg-white/3">▶</button>
    </div>
    <div>
      <button id="filterBtn" class="p-2 rounded-lg bg-white/3">Filter</button>
    </div>
  </div>
</section>

<!-- Week strip for mobile -->
<section class="px-4">
  <div id="weekStrip" class="flex gap-2 overflow-x-auto pb-2"></div>
</section>

<!-- Main Content -->
<main class="px-4 mt-3">
  <div id="jobsList" class="space-y-3"></div>

  <!-- Empty state -->
  <div id="emptyState" class="text-center py-12 opacity-70 hidden">
    <div class="text-xl font-bold mb-2">No jobs here</div>
    <div class="text-sm text-[--muted]">Try another tab or adjust filters</div>
  </div>
</main>

<!-- Floating refresh / add (mobile) -->
<div class="fixed bottom-6 right-4 z-50">
  <button id="floatingRefresh" class="big-btn bg-gradient-to-r from-slate-700 to-slate-600 text-white card">
    Refresh
  </button>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<!-- Job Detail Modal -->
<div id="jobModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60" onclick="closeModal(event)"></div>
  <div class="absolute left-0 right-0 bottom-0 rounded-t-2xl card p-4 max-h-[85vh] overflow-auto">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 id="modalTitle" class="text-lg font-bold"></h2>
        <div id="modalSubtitle" class="text-xs text-[--muted]"></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="p-2 rounded-lg bg-white/3" onclick="closeJobModal()">
          Close
        </button>
      </div>
    </div>

    <div id="modalBody"></div>
  </div>
</div>

<!-- Override Confirmation Modal -->
<div id="overrideModal" class="fixed inset-0 z-60 hidden">
  <div class="absolute inset-0 bg-black/70" onclick="closeOverrideModal()"></div>
  <div class="absolute inset-4 rounded-xl card p-4 max-h-[80vh] overflow-auto">
    <h3 class="text-lg font-bold mb-2">Confirm Override</h3>
    <p class="text-sm text-[--muted] mb-3">You are overriding the guest status and marking the unit ready to clean. Proceed only if you are certain guests have left or it is safe.</p>

    <label class="block text-sm mb-2">Optional note (why you override)</label>
    <textarea id="overrideNote" class="w-full p-3 rounded-lg bg-white/3 text-sm" rows="3" placeholder="e.g., Manager confirmed; I checked property; guests packed up..."></textarea>

    <div class="flex items-center gap-2 mt-3">
      <button id="confirmOverrideBtn" class="flex-1 big-btn bg-gradient-to-r from-emerald-500 to-green-600">Confirm & Start</button>
      <button class="flex-1 big-btn bg-white/3" onclick="closeOverrideModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Checklist Modal -->
<div id="checklistModal" class="fixed inset-0 z-70 hidden">
  <div class="absolute inset-0 bg-black/70" onclick="closeChecklistModal()"></div>
  <div class="absolute left-0 right-0 bottom-0 rounded-t-2xl card p-4 max-h-[85vh] overflow-auto">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-bold">Post-Cleaning Checklist</h3>
      <div class="text-sm text-[--muted]" id="checklistTimer">--</div>
    </div>

    <div id="checklistItems" class="space-y-3">
      <!-- checklist tiles injected here -->
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">Add photo (optional but helpful)</label>
      <label for="photoInput" class="w-full card p-3 rounded-lg cursor-pointer text-sm flex items-center gap-3">
        <svg class="w-6 h-6 text-[--muted]" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="3" y="7" width="18" height="13" rx="2" stroke-width="1.4"></rect>
          <path d="M8 11a2 2 0 112 2 2 2 0 01-2-2z" stroke-width="1.4"></path>
        </svg>
        <span id="photoLabel" class="text-sm text-[--muted]">Tap to take or choose photo</span>
      </label>
      <input id="photoInput" type="file" accept="image/*" capture="environment" />
      <div id="photoPreview" class="mt-3 hidden">
        <img id="photoImg" class="photo-thumb" alt="preview" />
        <button id="removePhotoBtn" class="mt-2 big-btn bg-white/3 w-full">Remove Photo</button>
      </div>
    </div>

    <div class="mt-4 flex gap-2">
      <button id="submitChecklistBtn" class="flex-1 big-btn bg-gradient-to-r from-purple-600 to-violet-600">Submit & Complete Job</button>
      <button class="flex-1 big-btn bg-white/3" onclick="closeChecklistModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/*
  Savvy OS - My Jobs (Dark Mode) - Single-file
  - Demo persistence: localStorage
  - Live integration: placeholders where to call Firestore
  - Optimized for mobile cleaners
*/

/* ------------------------------
   Demo Data & Persistence Layer
   ------------------------------ */
const STORAGE_KEY = 'savvy.jobs.v1';
const STORAGE_CHECKLIST_KEY = 'savvy.checklists.v1';
const STORAGE_PHOTOS_KEY = 'savvy.photos.v1';
const STORAGE_OVERRIDES_KEY = 'savvy.overrides.v1';

// Mock initial jobs (dates spread across the week)
const todayISO = (new Date()).toISOString().split('T')[0];
function addDays(dateStr, d) {
  const t = new Date(dateStr);
  t.setDate(t.getDate()+d);
  return t.toISOString().split('T')[0];
}
const INITIAL_JOBS = [
  { id: 101, location: 'Downtown Hotel', room:'205', startTime:'09:00', dueTime:'11:00', predictedTime:'2h', guestCount:2, dogCount:0, wifiIncluded:true, linenPickup:true, guestsOut:true, priority:'high', lockCode:'356374', date: todayISO, status:'assigned', permanentInstructions:'Standard deep clean', weekSpecificInstructions:'Focus bathroom' },
  { id: 102, location: 'Riverside Inn', room:'312', startTime:'12:00', dueTime:'14:00', predictedTime:'2h', guestCount:3, dogCount:1, wifiIncluded:true, linenPickup:false, guestsOut:false, priority:'normal', lockCode:'789456', date: addDays(todayISO, 0), status:'assigned', permanentInstructions:'Standard clean', weekSpecificInstructions:'Vacuum carpets' },
  { id: 103, location: 'City Center Lodge', room:'108', startTime:'14:30', dueTime:'17:00', predictedTime:'2.5h', guestCount:4, dogCount:0, wifiIncluded:true, linenPickup:true, guestsOut:true, priority:'high', lockCode:'112233', date: addDays(todayISO, 1), status:'assigned', permanentInstructions:'VIP - white glove', weekSpecificInstructions:'Polish surfaces' },
  { id: 104, location: 'Beachside BnB', room:'12', startTime:'08:00', dueTime:'09:30', predictedTime:'1.5h', guestCount:1, dogCount:0, wifiIncluded:false, linenPickup:false, guestsOut:false, priority:'low', lockCode:'000000', date: addDays(todayISO, 2), status:'assigned', permanentInstructions:'Quick turn', weekSpecificInstructions:'' },
  { id: 105, location: 'Lakeside Resort', room:'501', startTime:'10:00', dueTime:'12:00', predictedTime:'2h', guestCount:2, dogCount:0, wifiIncluded:true, linenPickup:true, guestsOut:false, priority:'normal', lockCode:'445566', date: addDays(todayISO, -1), status:'completed', completedAt: Date.now()-86400000, completedBy:'Sarah', checklistId: null }
];

// wrapper to load / save
function loadJobs() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(INITIAL_JOBS));
    return [...INITIAL_JOBS];
  }
  try { return JSON.parse(raw); } catch(e){ return [...INITIAL_JOBS]; }
}
function saveJobs(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  // Placeholder: in live, push to Firestore here
  // e.g. firebase.firestore().collection('jobs').doc(id).update({...})
}
function loadChecklists(){ return JSON.parse(localStorage.getItem(STORAGE_CHECKLIST_KEY)||'{}'); }
function saveChecklists(obj){ localStorage.setItem(STORAGE_CHECKLIST_KEY, JSON.stringify(obj)); }
function loadPhotos(){ return JSON.parse(localStorage.getItem(STORAGE_PHOTOS_KEY)||'{}'); }
function savePhotos(obj){ localStorage.setItem(STORAGE_PHOTOS_KEY, JSON.stringify(obj)); }
function loadOverrides(){ return JSON.parse(localStorage.getItem(STORAGE_OVERRIDES_KEY)||'{}'); }
function saveOverrides(obj){ localStorage.setItem(STORAGE_OVERRIDES_KEY, JSON.stringify(obj)); }

/* ------------------------------
   App State
   ------------------------------ */
let jobs = loadJobs();
let currentTab = 'today'; // today | week | upcoming | completed
let selectedDate = new Date(); // used for week strip selection
let weekStart = getStartOfWeek(selectedDate); // monday start
let activeJobId = null;

/* ------------------------------
   UI Helpers
   ------------------------------ */
function q(selector, el=document) { return el.querySelector(selector); }
function qq(selector, el=document) { return Array.from(el.querySelectorAll(selector)); }
function fmtDateISO(d) { return d.toISOString().split('T')[0]; }
function getStartOfWeek(dt) {
  const d = new Date(dt);
  const day = d.getDay(); // 0 Sun
  const diff = d.getDate() - (day === 0 ? 6 : day-1); // make Monday start
  const start = new Date(d.setDate(diff));
  start.setHours(0,0,0,0);
  return start;
}
function addDaysToDate(dateObj, days) {
  const t = new Date(dateObj);
  t.setDate(t.getDate()+days);
  return t;
}
function showToast(msg, delay=2200) {
  const t = q('#toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  t.classList.add('card','p-3','rounded-lg','text-sm');
  setTimeout(()=> t.classList.add('opacity-0'), 10);
  setTimeout(()=> {
    t.classList.add('hidden'); t.classList.remove('opacity-0');
  }, delay);
}

/* ------------------------------
   Rendering: Tabs, Week Strip, Jobs
   ------------------------------ */
function updateCounts() {
  const todayISO = (new Date()).toISOString().split('T')[0];
  q('#todayCount').textContent = jobs.filter(j=> j.date===todayISO && j.status==='assigned').length;
  q('#weekCount').textContent = jobs.filter(j=> isDateInWeek(j.date, weekStart) && j.status==='assigned').length;
  q('#upcomingCount').textContent = jobs.filter(j=> j.date > todayISO && j.status==='assigned').length;
  q('#completedCount').textContent = jobs.filter(j=> j.status==='completed').length;
}

function isDateInWeek(dateISO, startOfWeekDate) {
  const start = new Date(startOfWeekDate);
  start.setHours(0,0,0,0);
  const end = addDaysToDate(start, 6);
  const dt = new Date(dateISO + 'T00:00:00');
  return dt>=start && dt<=end;
}

function renderTabs() {
  qq('.tab-btn').forEach(btn => {
    if (btn.dataset.tab === currentTab) {
      btn.classList.add('text-cyan-200'); btn.classList.remove('text-[--muted]');
    } else {
      btn.classList.remove('text-cyan-200'); btn.classList.add('text-[--muted]');
    }
  });
  // indicator
  const mapping = ['today','week','upcoming','completed'];
  const idx = mapping.indexOf(currentTab);
  const indicator = q('#tabIndicator');
  indicator.style.left = `${idx * 25}%`;
  indicator.style.width = `25%`;
}

function renderWeekStrip() {
  const strip = q('#weekStrip');
  strip.innerHTML = '';
  const start = weekStart;
  for (let i=0;i<7;i++){
    const day = addDaysToDate(start,i);
    const iso = fmtDateISO(day);
    const label = day.toLocaleDateString(undefined,{weekday:'short', day:'numeric'});
    const isSelected = fmtDateISO(selectedDate) === iso;
    const jobsCount = jobs.filter(j=> j.date===iso && j.status==='assigned').length;
    const el = document.createElement('button');
    el.className = `card p-2 rounded-lg flex flex-col items-center week-day ${isSelected ? 'border-2 border-cyan-400' : 'bg-white/2'}`;
    el.innerHTML = `<div class="text-sm font-semibold">${label}</div><div class="text-xs text-[--muted]">${jobsCount} jobs</div>`;
    el.onclick = ()=> { selectedDate = day; renderJobs(); };
    strip.appendChild(el);
  }
  q('#weekControls').classList.remove('hidden');
  q('#weekLabel').textContent = `${start.toLocaleDateString()} - ${addDaysToDate(start,6).toLocaleDateString()}`;
}

function renderJobs() {
  updateCounts();
  renderTabs();
  renderWeekStrip();

  const container = q('#jobsList');
  container.innerHTML = '';
  const todayISO = (new Date()).toISOString().split('T')[0];

  let filtered = jobs.filter(j => {
    if (currentTab === 'today') return j.date === todayISO && j.status === 'assigned';
    if (currentTab === 'week') return isDateInWeek(j.date, weekStart) && j.status === 'assigned';
    if (currentTab === 'upcoming') return j.date > todayISO && j.status === 'assigned';
    if (currentTab === 'completed') return j.status === 'completed';
    return false;
  });

  // if none
  if (filtered.length === 0) {
    q('#emptyState').classList.remove('hidden');
    return;
  } else q('#emptyState').classList.add('hidden');

  // sort by date/time
  filtered.sort((a,b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return (a.startTime||'').localeCompare(b.startTime||'');
  });

  filtered.forEach(job => {
    const el = document.createElement('div');
    el.className = 'card p-3 rounded-xl';
    el.onclick = ()=> openJobModal(job.id);
    const statusBadge = job.guestsOut ? `<span class="text-xs px-2 py-1 rounded-full bg-emerald-800 text-emerald-200">READY</span>` : `<span class="text-xs px-2 py-1 rounded-full bg-yellow-800 text-yellow-200">GUESTS IN</span>`;
    const priority = job.priority==='high' ? `<span class="text-xs px-2 py-1 rounded-full bg-red-800 text-red-200">URGENT</span>` : '';
    el.innerHTML = `
      <div class="flex items-start justify-between">
        <div>
          <div class="flex items-center gap-2 mb-1">
            <h3 class="font-bold text-sm">${job.location} • Room ${job.room}</h3>
            ${priority}
          </div>
          <div class="text-xs text-[--muted]">${job.date} • ${job.startTime} - ${job.dueTime} • ${job.guestCount} guests ${job.dogCount? ' • '+job.dogCount+' dog(s)':''}</div>
        </div>
        <div class="text-right">
          ${statusBadge}
          <div class="text-xs text-[--muted] mt-2">${job.predictedTime || ''}</div>
        </div>
      </div>
      <div class="mt-3 grid grid-cols-3 gap-2">
        <button class="big-btn bg-gradient-to-r from-slate-700 to-slate-600 text-white" onclick="event.stopPropagation(); navigate(${job.id})">Navigate</button>
        <button class="big-btn bg-gradient-to-r from-emerald-600 to-green-600 text-white" onclick="event.stopPropagation(); callProperty(${job.id})">Call</button>
        <button class="big-btn bg-white/6" onclick="event.stopPropagation(); openJobModal(${job.id})">Details</button>
      </div>
    `;
    container.appendChild(el);
  });
}

/* ------------------------------
   Job Modal & Actions
   ------------------------------ */
function openJobModal(jobId) {
  activeJobId = jobId;
  const job = jobs.find(j=> j.id===jobId);
  if (!job) return;
  q('#modalTitle').textContent = `${job.location} — Room ${job.room}`;
  q('#modalSubtitle').textContent = `${job.date} • ${job.startTime} - ${job.dueTime}`;

  const modalBody = q('#modalBody');
  modalBody.innerHTML = `
    <div class="space-y-3">
      <div class="card p-3 rounded-lg">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-xs text-[--muted]">Status</div>
            <div class="font-semibold">${job.guestsOut ? 'Guests out — Ready to clean' : 'Guests still in'}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-[--muted]">Priority</div>
            <div class="font-semibold">${job.priority.toUpperCase()}</div>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <div><div class="text-xs text-[--muted]">Lock Code</div><div class="font-semibold">${job.lockCode}</div></div>
          <div><div class="text-xs text-[--muted]">Linen Pickup</div><div class="font-semibold">${job.linenPickup ? 'Yes' : 'No'}</div></div>
        </div>
      </div>

      <div class="card p-3 rounded-lg">
        <div class="text-xs text-[--muted]">Instructions</div>
        <div class="font-semibold mt-1">${job.permanentInstructions || ''}</div>
        <div class="text-[--muted] text-sm mt-2">${job.weekSpecificInstructions || ''}</div>
      </div>

      <div class="flex gap-2">
        <button class="flex-1 big-btn bg-gradient-to-r from-purple-600 to-violet-600 text-white" onclick="event.stopPropagation(); startJobFlow(${job.id})">${job.guestsOut ? 'Start Cleaning' : 'Start Cleaning (Override)'}</button>
        <button class="flex-1 big-btn bg-white/6" onclick="event.stopPropagation(); openChecklistModal(${job.id}, false)">Open Checklist</button>
      </div>
    </div>
  `;

  q('#jobModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeJobModal() {
  q('#jobModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}
function closeModal(e){ if (e.target.id==='jobModal') closeJobModal(); }

/* ------------------------------
   Start Job Flow (with Override)
   ------------------------------ */
function startJobFlow(jobId) {
  const job = jobs.find(j=> j.id===jobId);
  if (!job) return;
  if (job.guestsOut) {
    // Normal start
    markJobInProgress(jobId);
  } else {
    // Need override confirmation
    openOverrideModal(jobId);
  }
}

function markJobInProgress(jobId, overrideNote='') {
  const job = jobs.find(j=> j.id===jobId);
  if (!job) return;
  // mark started (for demo just show toast + open checklist)
  showToast('Starting job — open checklist to complete.');
  closeJobModal();

  // store override note if present
  if (overrideNote) {
    const overrides = loadOverrides();
    overrides[jobId] = { at: Date.now(), note: overrideNote, by: (q('#cleanerName').textContent||'') };
    saveOverrides(overrides);
    // Placeholder: send override log to Firestore
  }

  // In a live app: set job.status = 'in_progress' and save
  job.status = 'in_progress';
  saveJobs(jobs);

  // Open checklist modal automatically
  openChecklistModal(jobId, true);
}

/* ------------------------------
   Override Modal
   ------------------------------ */
function openOverrideModal(jobId) {
  activeJobId = jobId;
  q('#overrideNote').value = '';
  q('#overrideModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  q('#confirmOverrideBtn').onclick = () => {
    const note = q('#overrideNote').value.trim();
    closeOverrideModal();
    markJobInProgress(jobId, note);
  };
}
function closeOverrideModal() {
  q('#overrideModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

/* ------------------------------
   Checklist: items, photo, submit
   ------------------------------ */
const DEFAULT_CHECKLIST = [
  { key:'trash', label:'Trash emptied' },
  { key:'dust', label:'Surfaces dusted & wiped' },
  { key:'bath', label:'Bathroom sanitized' },
  { key:'linens', label:'Towels/linens replaced' },
  { key:'floors', label:'Floors vacuumed/mopped' }
];

let currentChecklistJobId = null;
let selectedPhotoData = null;

function openChecklistModal(jobId, autoOpen=true) {
  currentChecklistJobId = jobId;
  selectedPhotoData = null;
  q('#photoPreview').classList.add('hidden');
  q('#photoImg').src = '';
  q('#photoLabel').textContent = 'Tap to take or choose photo';

  // build checklist tiles
  const container = q('#checklistItems');
  container.innerHTML = '';
  DEFAULT_CHECKLIST.forEach(item => {
    const div = document.createElement('div');
    div.className = 'card p-3 rounded-lg flex items-center justify-between check-tile';
    div.innerHTML = `
      <div>
        <div class="font-semibold">${item.label}</div>
        <div class="text-xs text-[--muted]">Tap to toggle</div>
      </div>
      <button class="w-12 h-12 rounded-lg bg-white/6 text-xl" data-key="${item.key}">✓</button>
    `;
    const btn = div.querySelector('button');
    btn.dataset.checked = 'false';
    btn.onclick = (e) => {
      e.stopPropagation();
      const c = btn.dataset.checked === 'true' ? 'false' : 'true';
      btn.dataset.checked = c;
      btn.classList.toggle('bg-emerald-700', c==='true');
      btn.classList.toggle('text-white', c==='true');
    };
    container.appendChild(div);
  });

  // set checklist timer (optional)
  q('#checklistTimer').textContent = 'Start: ' + new Date().toLocaleTimeString();

  // photo input
  q('#photoInput').onchange = handlePhotoInput;
  q('#photoLabel').onclick = ()=> q('#photoInput').click();
  q('#removePhotoBtn').onclick = ()=> { selectedPhotoData = null; q('#photoPreview').classList.add('hidden'); q('#photoImg').src=''; q('#photoLabel').textContent='Tap to take or choose photo'; };

  // Submit
  q('#submitChecklistBtn').onclick = submitChecklist;

  q('#checklistModal').classList.remove('hidden');
  if (autoOpen) closeJobModal();
  document.body.style.overflow = 'hidden';
}

function closeChecklistModal() {
  q('#checklistModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function handlePhotoInput(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    selectedPhotoData = ev.target.result; // base64
    q('#photoImg').src = selectedPhotoData;
    q('#photoPreview').classList.remove('hidden');
    q('#photoLabel').textContent = 'Photo attached';
  };
  reader.readAsDataURL(file);
}

function submitChecklist() {
  // gather checked items
  const buttons = qq('#checklistItems button');
  const results = {};
  buttons.forEach(b => results[b.dataset.key] = (b.dataset.checked === 'true'));

  // For efficiency: require at least 2 items (trash + bath) to mark complete OR allow if photo + two items. Keep it easy.
  const required = ['trash','bath'];
  const hasRequired = required.every(r => results[r]);
  const checkedCount = Object.values(results).filter(Boolean).length;

  if (!hasRequired && checkedCount < 2 && !selectedPhotoData) {
    alert('Please complete at least two checklist items (including Trash emptied and Bathroom sanitized recommended) or attach a photo.');
    return;
  }

  // save checklist
  const checklists = loadChecklists();
  const id = 'cl_' + currentChecklistJobId + '_' + Date.now();
  checklists[id] = { jobId: currentChecklistJobId, results, photoId: null, ts: Date.now(), by: q('#cleanerName').textContent || 'Unknown' };

  // save photo (if present)
  if (selectedPhotoData) {
    const photos = loadPhotos();
    const pid = 'ph_' + currentChecklistJobId + '_' + Date.now();
    photos[pid] = { data: selectedPhotoData, ts: Date.now(), by: q('#cleanerName').textContent || 'Unknown' };
    savePhotos(photos);
    checklists[id].photoId = pid;
  }

  saveChecklists(checklists);

  // mark job completed
  const jobIdx = jobs.findIndex(j=> j.id===currentChecklistJobId);
  if (jobIdx > -1) {
    jobs[jobIdx].status = 'completed';
    jobs[jobIdx].completedAt = Date.now();
    jobs[jobIdx].completedBy = q('#cleanerName').textContent || 'Unknown';
    jobs[jobIdx].checklistId = id;
    saveJobs(jobs);
  }

  // Placeholder: here you'd push checklist and photo to Firestore
  // Example (pseudo):
  // await firestore.collection('checklists').doc(id).set(checklists[id]);
  // if (selectedPhotoData) { upload to storage and store URL }

  showToast('Checklist saved — job completed ✅');
  closeChecklistModal();
  renderJobs();
}

/* ------------------------------
   Small helper actions
   ------------------------------ */
function navigate(jobId) {
  const job = jobs.find(j=> j.id===jobId);
  if (!job) return;
  const addr = encodeURIComponent(job.location + ' ' + (job.address||''));
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${addr}`, '_blank');
}
function callProperty(jobId) {
  showToast('Calling property manager...');
  // in live, you may open tel: link or call through back-end
}

/* ------------------------------
   Initial wiring & events
   ------------------------------ */
document.addEventListener('DOMContentLoaded', ()=>{
  // tabs
  qq('.tab-btn').forEach(btn => {
    btn.onclick = ()=> { currentTab = btn.dataset.tab; renderJobs(); };
  });

  // refresh buttons
  q('#refreshBtn').onclick = ()=> { jobs = loadJobs(); renderJobs(); showToast('Refreshed'); };
  q('#floatingRefresh').onclick = ()=> { jobs = loadJobs(); renderJobs(); showToast('Refreshed'); };

  // week nav
  q('#prevWeek').onclick = ()=> { weekStart = addDaysToDate(weekStart, -7); renderJobs(); };
  q('#nextWeek').onclick = ()=> { weekStart = addDaysToDate(weekStart, 7); renderJobs(); };

  // init
  renderJobs();
});

/* ------------------------------
   Extra: expose small API for dev
   ------------------------------ */
window.SavvyDemo = {
  loadJobs, saveJobs, jobsRef: ()=> jobs, resetDemo: ()=> { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(STORAGE_CHECKLIST_KEY); localStorage.removeItem(STORAGE_PHOTOS_KEY); localStorage.removeItem(STORAGE_OVERRIDES_KEY); jobs = loadJobs(); renderJobs(); }
};

</script>
</body>
</html>
